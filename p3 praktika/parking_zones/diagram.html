<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" hrefÐ¤="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700;800&display=swap">

    <!--IZPOLZVA jQuery, NO ZA DA NE SE TEGLI, SE IZPOLZVA TOZI LINK-->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <title>Document</title>
</head>

<body>
    
    <div id="particle-canvas"></div>
    <div class="overflow-hidden rounded-2 d-flex justify-content-center position-relative m-auto"
        style="background-color: #e6bd4c; height: 260px; width: 330px; box-shadow: 0px 2px 16px #e6bd4c, 0px 2px 3px #ededeb inset; border: 1px solid #ededeb;">
        <canvas class="position-absolute" style="height: 260px; width: 330px;"></canvas>
        <div class="position-absolute d-flex justify-content-center"
            style="height: 260px; width: 330px; text-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5); color: white;">

            <div class="d-flex flex-column my-auto">
                <h2 class="fs-2" id="avail-text">78%</h2>
                <p class="fs-5">Capacity</p>
            </div>
        </div>
    </div>

    <script src="../js_animation_canvas/particle.js"></script>
    <script>
        //CALCULATING
        const allParkingSpots = 18; //doesn't need to be gotten from the DB
        var avail_text = document.getElementById('avail-text');

        function loadAvailability() {
            let bookedSpots = ["A1", "A2", "A5", "A10", "B4", "B5", "B7", "B8"]; //this we get from DB
            let availSpots = Number(allParkingSpots - bookedSpots.length); //this we calculate
            availSpots /= allParkingSpots;
            availSpots *= 100;
            avail_text.innerText = (String(availSpots.toFixed(0)).padStart(2, '0')) + "%";
            return (availSpots / 100).toFixed(2);
        }

        //CANVA
        window.requestAnimFrame = (function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 1000 / 60);
                };
        })();

        var canvas = $('canvas')[0];
        var cxt = canvas.getContext('2d');
        var width = $('canvas').width();
        var height = $('canvas').height();
        canvas.width = width;
        canvas.height = height;
        var center = { x: width / 2, y: height / 2 };
        var value = loadAvailability();
        var initialValue = 0;

        var rotation = Math.random() * Math.PI * 2;

        var draw = function () {
            rotation += .001;

            if (rotation >= Math.PI * 2)
                rotation -= Math.PI * 2;

            if (Math.abs(initialValue - value) < .001)
                initialValue = value;

            if (initialValue != value) {
                initialValue += (value - initialValue) / 50;
                $('.widget h2').html(Math.round(initialValue * 100) + '%');
            }

            cxt.clearRect(0, 0, width, height);
            cxt.save();

            cxt.translate(center.x, center.y);
            cxt.rotate(rotation)

            cxt.lineWidth = 35;
            cxt.beginPath();
            cxt.arc(0, 0, 100, 0, Math.PI * 2, false);
            var grad = cxt.createLinearGradient(0, 0, 0, height);
            grad.addColorStop(0, "#202020");
            grad.addColorStop(1, "#202020");
            cxt.strokeStyle = grad;
            cxt.shadowBlur = 10;
            cxt.shadowColor = "rgba(0,0,0,.5)";
            cxt.shadowOffsetX = 0;
            cxt.shadowOffsetY = 4;
            cxt.stroke();

            cxt.beginPath();
            cxt.arc(0, 0, 120, rotation, Math.PI * 2 * initialValue + rotation, false);
            grad = cxt.createLinearGradient(0, 0, 0, height);
            grad.addColorStop(0, "#6D6C58");
            grad.addColorStop(1, "#ADADA2");
            cxt.strokeStyle = grad;
            cxt.shadowBlur = 10;
            cxt.shadowColor = "rgba(0,0,0,.5)";
            cxt.shadowOffsetX = 0;
            cxt.shadowOffsetY = 4;
            cxt.stroke();

            cxt.restore();
            requestAnimFrame(draw);
        }
        draw();
    </script>
</body>

</html>